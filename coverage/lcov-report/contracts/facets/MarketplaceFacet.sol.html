<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/facets/MarketplaceFacet.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/facets/</a> MarketplaceFacet.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>44/44</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>30/30</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>10/10</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>54/54</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">82×</span>
<span class="cline-any cline-yes">82×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">42×</span>
<span class="cline-any cline-yes">42×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20×</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-yes">17×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">16×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;
&nbsp;
import "@openzeppelin/contracts/token/ERC721/IERC721.sol";
import {LibDiamond} from "../LibDiamond.sol";
&nbsp;
library LibMarketplace {
    bytes32 constant MARKETPLACE_STORAGE_POSITION = keccak256("diamond.storage.marketplace");
&nbsp;
    struct Listing {
        uint256 price;
        address seller;
    }
&nbsp;
    struct MarketplaceStorage {
        mapping(uint256 =&gt; Listing) listings;
        uint256 itemIds;
        uint256 fee; // fee numerator, denominator fixed to 1000
        uint256 feesCollected; // accumulated fees held in contract until withdrawal
    }
&nbsp;
    function marketplaceStorage() internal pure returns (MarketplaceStorage storage ms) {
        bytes32 position = MARKETPLACE_STORAGE_POSITION;
        assembly { ms.slot := position }
    }
}
&nbsp;
contract MarketplaceFacet {
    uint256 public constant FEE_DENOMINATOR = 1000;
&nbsp;
    event ItemListed(uint256 indexed itemId, address indexed nftContract, uint256 indexed tokenId, address seller, uint256 price);
    event ItemSold(uint256 indexed itemId, address indexed nftContract, uint256 indexed tokenId, address seller, address buyer, uint256 price);
    event ItemCanceled(uint256 indexed itemId, address indexed nftContract, uint256 indexed tokenId, address seller);
    event FeeUpdated(uint256 newFee);
    event FeeWithdrawn(address indexed owner, uint256 amount);
    event PriceUpdated(uint256 indexed itemId, uint256 newPrice);
&nbsp;
    function initMarketplace(uint256 _fee) external {
        LibDiamond.enforceIsContractOwner();
        LibMarketplace.marketplaceStorage().fee = _fee;
    }
&nbsp;
    function fee() external view returns (uint256) {
        return LibMarketplace.marketplaceStorage().fee;
    }
&nbsp;
    function listItem(address nftContract, uint256 tokenId, uint256 price) external {
        require(price &gt; 0, "Price must be greater than zero");
        IERC721 nft = IERC721(nftContract);
        require(nft.ownerOf(tokenId) == msg.sender, "Not the owner");
        // Allow approval by specific token or operator approval
        bool approvedForAll = nft.isApprovedForAll(msg.sender, address(this));
        address approved = nft.getApproved(tokenId);
        require(approvedForAll || approved == address(this), "NFT not approved");
&nbsp;
        LibMarketplace.MarketplaceStorage storage ms = LibMarketplace.marketplaceStorage();
        ms.itemIds++;
        uint256 itemId = ms.itemIds;
        ms.listings[itemId] = LibMarketplace.Listing(price, msg.sender);
&nbsp;
        emit ItemListed(itemId, nftContract, tokenId, msg.sender, price);
    }
&nbsp;
    function buyItem(uint256 itemId, address nftContract, uint256 tokenId) external payable {
        LibMarketplace.MarketplaceStorage storage ms = LibMarketplace.marketplaceStorage();
        LibMarketplace.Listing memory listing = ms.listings[itemId];
        require(listing.price &gt; 0, "Item not listed");
        require(msg.value &gt;= listing.price, "Insufficient payment");
        // Remove listing first to avoid reentrancy on external calls
        delete ms.listings[itemId];
&nbsp;
        uint256 feeAmount = (listing.price * ms.fee) / FEE_DENOMINATOR;
        uint256 sellerAmount = listing.price - feeAmount;
&nbsp;
        // Accumulate fee in contract balance accounting
        ms.feesCollected += feeAmount;
&nbsp;
        // Pay seller
        (bool sellerSuccess, ) = payable(listing.seller).call{value: sellerAmount}("");
        require(sellerSuccess, "Seller transfer failed");
&nbsp;
        // Transfer NFT to buyer
        IERC721(nftContract).safeTransferFrom(listing.seller, msg.sender, tokenId);
&nbsp;
        emit ItemSold(itemId, nftContract, tokenId, listing.seller, msg.sender, listing.price);
&nbsp;
        // Refund overpayment if any
        if (msg.value &gt; listing.price) {
            (bool refundSuccess, ) = payable(msg.sender).call{value: msg.value - listing.price}("");
            require(refundSuccess, "Refund failed");
        }
    }
&nbsp;
    function cancelListing(uint256 itemId, address nftContract, uint256 tokenId) external {
        LibMarketplace.MarketplaceStorage storage ms = LibMarketplace.marketplaceStorage();
        LibMarketplace.Listing memory listing = ms.listings[itemId];
        require(listing.seller == msg.sender, "Not the seller");
&nbsp;
        delete ms.listings[itemId];
&nbsp;
        emit ItemCanceled(itemId, nftContract, tokenId, msg.sender);
    }
&nbsp;
    function updateFee(uint256 newFee) external {
        LibDiamond.enforceIsContractOwner();
        require(newFee &lt;= 100, "Fee too high");
        LibMarketplace.marketplaceStorage().fee = newFee;
        emit FeeUpdated(newFee);
    }
&nbsp;
    function updateListingPrice(uint256 itemId, uint256 newPrice) external {
        LibMarketplace.MarketplaceStorage storage ms = LibMarketplace.marketplaceStorage();
        require(ms.listings[itemId].seller == msg.sender, "Not the seller");
        require(newPrice &gt; 0, "Price must be greater than zero");
        ms.listings[itemId].price = newPrice;
        emit PriceUpdated(itemId, newPrice);
    }
&nbsp;
    function withdrawFees() external {
        LibDiamond.enforceIsContractOwner();
        LibMarketplace.MarketplaceStorage storage ms = LibMarketplace.marketplaceStorage();
        uint256 amount = ms.feesCollected;
        require(amount &gt; 0, "No fees to withdraw");
        ms.feesCollected = 0;
        (bool success, ) = payable(LibDiamond.contractOwner()).call{value: amount}("");
        require(success, "Withdrawal failed");
        emit FeeWithdrawn(LibDiamond.contractOwner(), amount);
    }
&nbsp;
    function getListing(uint256 itemId) external view returns (LibMarketplace.Listing memory) {
        return LibMarketplace.marketplaceStorage().listings[itemId];
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Nov 25 2025 22:52:11 GMT+0100 (hora estándar de Europa central)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
